<html>
    <head>
        <link rel="stylesheet" href="index.css">
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    </head>
    <body>

        <!-- <div class="popup-square">
            <span id="close" onclick="this.parentNode.remove(); return false;">X</span>
        </div> -->

        <!-- <div class="popup">
            <div class="popup-content">PARTY DI CAPODANNO 2022</div>
            <a class="nostyle" href="./images/capodanno21-full.png" target="_blank">
                <div class="popup-button">SCOPRI DI PIÃš</div>
            </a>
        </div> -->


        <div class="home" style="display: none;">
            <div class="home-content">
            
                <!-- <div class="title">BENVENUTO</div> -->

                <div style="background-image: url(./images/jb_logo.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 100%; height: auto; flex-grow: 6;"></div>

                <div class="title-big">BENVENUTO!</div>
                
                <div class="title" style="cursor: pointer;" onclick="closeHome()">VAI AL MENU</div>

                <br/>

                <!-- <a class="nostyle title" style="cursor: pointer;" href="./files/MENU-2021-REV5.pdf" download="menu-jb.pdf">SCARICA PDF</a> -->

                <div class="text"><div>Prima di ordinare, verifica attentamente l'elenco degli allergeni e degli ingredienti in ciascuna pietanza:</div></div>
                <div class="text" style="display: flex; flex-wrap:wrap; gap: 3vmin;">
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_celery.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Sedano</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_crustaceans.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Crostacei</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_eggs.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Uova</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_fish.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Pesce</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_gluten.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Glutine</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_lupin.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Lupino</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_milk.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Lattosio</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_molluscs.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Molluschi</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_mustard.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Senape</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_peanuts.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Arachidi</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_sesame.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Sesamo</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_soya.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Soia</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_sulphites.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Solfiti</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_tree_nuts.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Frutta a guscio</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_spicyhot.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Piccante</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1vmax; align-items: center; align-content: center; justify-content: center; justify-items: center;">
                        <div style="background-image: url(./images/allergens_vegan.png); background-repeat: no-repeat; background-position: center; background-size: contain; width: 3vh; height: 3vh;"></div>
                        <div class="text-small">Vegan</div>
                    </div>

                    <!-- <div>Glutine</div>
                    <div>Arachidi</div>
                    <div>Sedano</div>
                    <div>Senape</div>
                    <div>Pesce</div>
                    <div>Soia</div>
                    <div>Solfiti</div>
                    <div>Uova</div>
                    <div>Latte</div>
                    <div>Frutta a guscio</div>
                    <div>Molluschi</div>
                    <div>Crostacei</div>
                    <div>Sesamo</div>
                    <div>Lupino</div>
                    <div>Piccante</div>
                    <div>Vegan</div> -->
                </div>
                <div class="text">Restiamo a disposizione per ulteriori informazioni.</div>
                <div class="text-small" style="flex-direction: column;">
                    <div>Le preparazioni contrassegnate da "*" e "**" indicano</div>
                    <div>* prodotto congelato all'origine</div>
                    <div>** prodotto congelato in loco con abbattimento rapido</div>
                </div>
            </div>
        </div>

        <div id="page" style="position:fixed; left: 0; top: 0; visibility: visible;">
            <!-- <div class="logo"></div> -->
            <div v-if="currentCategory">
                <div class="category-box box">
                    <div style="margin-right: 5vw; background-repeat: no-repeat; background-position: center; background-size: contain;" v-bind:style="{ 'background-image': 'url(\'./images/categories/' + currentCategory.id + '.jpg\')'}"></div>
                    <div class="category-title" v-on:click="currentCategory.selected = false; currentCategory = null;">
                        <!-- <div style="display: grid; grid-template-rows: 1fr 1fr;"> -->
                        <div v-bind:class="{ 'subcategory-header': currentSubcategory }">
                            <div>{{currentCategory.name}}</div>
                        </div>
                    </div>
                    <div class="category-button minus" v-on:click="currentCategory.selected = false; currentCategory = null;"></div>
                    <!-- <div class="category-subtitle">SOTTOTITOLO</div> -->
                </div>          
                <div class="subcategory-box box" v-if="currentSubcategory" v-on:click="toggleSubcategory(currentSubcategory)">
                    <div class="subcategory-title" v-bind:data-category-id="currentCategory.id" v-bind:data-subcategory-id="currentSubcategory.id">{{currentSubcategory.name}}</div>
                    <div class="category-button" v-bind:class="{'minus':currentSubcategory.expanded, 'plus':!currentSubcategory.expanded}"></div>
                    <!-- <div v-on:click.stop="currentSubcategory.expanded = false" style="margin-right: 1vw;" class="category-button close"></div>
                    <div>{{currentSubcategory.name}}</div> -->
                </div>
                <div class="items-container">
                    <div v-for="subcategory in currentCategory.subcategories" v-if="!subcategory.hidden" class="observable" v-bind:data-category-id="currentCategory.id" v-bind:data-subcategory-id="subcategory.id">
                        <div class="subcategory-box box" v-on:click="toggleSubcategory(subcategory)">
                            <div class="subcategory-title observable" data-subcategory-header="true" v-bind:data-category-id="currentCategory.id" v-bind:data-subcategory-id="subcategory.id">{{subcategory.name}}</div>
                            <div class="category-button" v-bind:class="{'minus':subcategory.expanded, 'plus':!subcategory.expanded}"></div>
                        </div>
                        <div v-if="subcategory.expanded">

                            <div v-for="item in subcategory.items" style="position: relative;">

                                <img v-if="item.hidden" src="images/coming_soon.png" style="position: absolute; left: 10vw; height: 15vh; z-index: 10;"></img>

                                <div class="item-box box" v-bind:class="{'box-unavailable': item.hidden}">
                                    <!-- <div class="item-column"> -->
                                    
                                    <div style="display: flex; flex-direction: column; gap: 2vh;">

                                        <div style="display: grid; grid-template-columns: 0.6fr 1.4fr; column-gap: 2vw; height: 15vh;">

                                            <!-- <div style="background-image: url(./images/magnifier.png); background-repeat: no-repeat; background-position: center; background-size: contain;"> -->
                                            <div style="width: 15vh; background-repeat: no-repeat; background-position: center; background-size: contain;" v-bind:style="{ 'background-image': 'url(\'./images/items/thumbs/' + item.id + '_t.jpg\')'}" v-on:click="showImagePopup('./images/items/pics/' + item.id + '.jpg')"></div>

                                            <div class="item-title-bar">
                                                <div class="item-title">{{item.name}}</div>
                                                <img :content="infoTooltip(info)" v-tippy="{ trigger : 'mouseenter', size: 'large', arrow: 'true' }" class="info-icon" v-for="info in item.infos" v-bind:src="'images/allergens_' + info + '.png'">
                                            </div>

                                        </div>
                                    
                                    </div>

                                    <div class="prices-grid" >
                                        <div class="prices-row" v-for="size in item.sizes" style="display: flex; flex-direction: column; align-items: center; justify-items: center; align-content: center; justify-content: center;">
                                            <div class="item-price">{{size.price}} â‚¬</div>
                                            <div class="item-label">{{size.label}}</div>
                                        </div>
                                        <!-- <template v-for="size in item.sizes"> -->
                                            <!-- <div class="item-description" style="white-space: nowrap;">{{size.label}}</div>
                                            <div class="item-description" style="white-space: nowrap;">{{size.price}}</div> -->
                                            <!-- <div class="item-price">{{size.label}}</div>
                                            <div class="item-price">{{size.price}}</div> -->
                                        <!-- </template> -->
                                    </div>

                                    <div class="item-description" style="text-align:justify; text-justify: newspaper;">{{item.description}}</div>

                                    <div class="allergens-row">
                                        <div v-if="item.allergens.length">Contiene:</div>
                                        <img :content="infoTooltip(allergen)" v-tippy="{ trigger : 'mouseenter', size: 'large', arrow: 'true' }" class="info-icon" v-for="allergen in item.allergens" v-bind:src="'images/allergens_' + allergen + '.png'">
                                    </div>

                                    <!-- <div class="item-description" style="margin-top: 1vh;">{{item.description}}</div>
                                    <div class="item-description" style="display: flex; align-items: center; margin-top: 2vh;">
                                        <span style="margin-right: 1vh;">Contiene:</span>
                                        <img :content="infoTooltip(allergen)" v-tippy="{ trigger : 'mouseenter', size: 'large', arrow: 'true' }" class="info-icon" v-for="allergen in item.allergens" v-bind:src="'images/allergens_' + allergen + '.png'">
                                    </div> -->

                                    <!-- </div> -->
                                    <!-- <div class="prices-grid"> -->
                                        <!-- <template v-for="size in item.sizes"> -->                         
                                        <!-- </template> -->
                                    <!-- </div>     -->
                                </div>
                            </div>
                        </div>
                    </div>
    
                </div>
            </div>
            <div class="categories-column" v-if="!currentCategory">
                <!-- <div v-for="category in categories" v-bind:category="category" v-bind:style="{ 'background-image': 'url(\'./images/JB.macro.headers_' + category.id + '_ita.jpg\')'}"> -->
                <div v-for="category in visibleCategories">
                    <!-- <div class="category-box box" v-on:click="category.selected = !category.selected; currentCategory = category.selected ? category : null;"> -->
                    <div class="category-box box" v-on:click="category.selected = true; currentCategory = category;">
                        <!-- <div class="category-image"></div> -->
                        <div style="margin-right: 5vw; background-repeat: no-repeat; background-position: center; background-size: contain;" v-bind:style="{ 'background-image': 'url(\'./images/categories/' + category.id + '.jpg\')'}"></div>
                        <div class="category-title"><span>{{category.name}}</span></div>
                        <div class="category-button plus"></div>
                        <!-- <div class="category-subtitle">SOTTOTITOLO</div> -->
                    </div>
                </div>
                <div style="min-height: 18vh; width: 100%; background-image: url(./images/jb_logo.png); background-repeat: no-repeat; background-position: center; background-size: contain;"></div>
            </div>
        </div>
        <div class="backdrop" onclick="closeImagePopup()">
            <div class="popup" onclick="closeImagePopup()">
                <div class="popup-image-loading" style="color: white;">CARICAMENTO...</div>
                <img src="./images/items/pics/chili_carne.jpg" class="popup-image" onload="onImageLoaded()"/>
                <div class="popup-image-exit" style="color: white;">TORNA AL MENU</div>
            </div>
        </div>
    </body>

    
</html>

<script src="https://unpkg.com/vue-tippy@4/dist/vue-tippy.min.js"></script>

<script type="text/javascript">

var page = new Vue({
    el: '#page',
    data: {
        homeClosed: false,
        observer: null,
        currentCategory: null,
        categories: [],
        infos: {
            "celery": { "name": "Sedano" },
            "crustaceans": { "name": "Crostacei" },
            "eggs": { "name": "Uova" },
            "fish": { "name": "Pesce" },
            "gluten": { "name": "Glutine" },
            "herbs": { "name": "Speziato" },
            "lupin": { "name": "Lupino" },
            "milk": { "name": "Lattosio" },
            "molluscs": { "name": "Molluschi" },
            "mustard": { "name": "Senape" },
            "peanuts": { "name": "Arachidi" },
            "sesame": { "name": "Sesamo" },
            "soya": { "name": "Soia" },
            "spicyhot": { "name": "Piccante" },
            "sulphites": { "name": "Solfiti" },
            "tree_nuts": { "name": "Frutta a guscio" },
            "vegan": { "name": "Vegan" },
        },
        // stopSubcats: [
        //     "variations",
        //     "aperitivo",
        //     "menu_tema"
        // ],
        // stopItems: [
        //     "floreffe",
        //     "beamish",
        //     "slalom",
        //     "pecos",
        //     "hp weizen",
        //     "pandora",
        //     "limited edition",
        //     "capodanno"
        // ]
    },
    computed: {
        visibleCategories() {
            return this.categories.filter(cat => cat.id != 'distillati_shots_co')
        },
        currentSubcategory() {
            let visibleSubcategories = []
            this.categories.forEach((category) => {
                category.subcategories.forEach((subcategory) => {
                    if (subcategory.visible) visibleSubcategories.push(subcategory)
                })
            })


            let anyHeaderVisible = false
            this.categories.forEach((category) => {
                category.subcategories.forEach((subcategory) => {
                    if (subcategory.headerVisible) anyHeaderVisible = true
                })
            })

            // console.log(visibleSubcategories)
            if (visibleSubcategories.length != 1 || anyHeaderVisible) return null
            else return visibleSubcategories[0]
        }
    },
    methods: {
        // showTooltip(event) {
        //     let element = event.target
        //     // let content = element.title
        //     tippy(element, {
        //         trigger: "manual",
        //         onShow: function(instance) {
        //             setTimeout(() => {
        //                 instance.destroy()
        //             }, 800);
        //         }
        //     }).show()
        // },
        toggleSubcategory(subcategory) {
            if (!subcategory.expanded) { 
                this.categories.forEach(cat => {
                    if (cat.subcategories.filter(subcat => subcat == subcategory).length > 0) {
                        cat.subcategories.forEach(subcat => {
                            if (subcat != subcategory)
                                subcat.expanded = false
                        })
                    }
                })
            }
            subcategory.expanded  = !subcategory.expanded
        },
        showImagePopup(src) {
            let backdrop = document.getElementsByClassName("backdrop")[0]
            let popup = document.getElementsByClassName("popup")[0]
            let image = document.getElementsByClassName("popup-image")[0]
            let loading = document.getElementsByClassName("popup-image-loading")[0]
            let exit = document.getElementsByClassName("popup-image-exit")[0]
            backdrop.style.display = "block"
            popup.style.display = "block"
            loading.style.visibility = 'visible'
            loading.style.display = "block"
            exit.style.visibility = 'hidden'
            exit.style.display = "block"
            image.src = src
        },
        infoTooltip(info) {
            return this.infos[info].name
        },
        onElementObserved(entries) {
            entries.forEach((entry) => {
                let subcategory = this.lookup(entry.target.dataset.categoryId, entry.target.dataset.subcategoryId)
                let subcategoryHeader = entry.target.dataset.subcategoryHeader ? true : false

                // console.log(entry)

                if (subcategoryHeader) {
                    subcategory.headerVisible = entry.isIntersecting
                }
                else {
                    subcategory.visible = entry.isIntersecting
                }

                // console.log("subcat " + subcategory.name + " vis " + subcategory.visible + " head " + subcategory.headerVisible)

                // console.log(subcategoryHeader)
                // console.log(this.currentSubcategory)
                // console.log(entry.isIntersecting)

                
            })
        },
        lookup(categoryId, subcategoryId) {
            let category = this.categories.filter((category) => category.id == categoryId)[0]
            let subcategory = null
            if (subcategoryId !== undefined ) {
                subcategory = category.subcategories.filter((subcategory) => subcategory.id == subcategoryId)[0]
                return subcategory
            }
            else return category
        }
    },
    created: function () {

        let options = {
            root: this.$el,
            rootMargin: '0px',
            // threshold: 1.0
            threshold: 0
        }
        this.observer = new IntersectionObserver(this.onElementObserved, options);

        Promise.all([
            fetch("./context.json"),
            fetch("./variations.json")
        ]).then(resps => {

            Promise.all([resps[0].json(), resps[1].json()]).then((jsons) => {

                let context = jsons[0]
                let variations = jsons[1]

                console.log(context, variations)
                
                context.categories.forEach(category => {
                    category.selected = false

                    category.subcategories.forEach(subcategory => {
                        subcategory.expanded = false
                        subcategory.visible = null
                        subcategory.headerVisible = null

                        subcategory.items.forEach(item => {
                            let itemId = item.id
                            let variation = variations[itemId]

                            if (variation) {
                                if (variation.name != null && variation.name != undefined)
                                    item.name = variation.name
                                if (variation.hidden != null && variation.hidden != undefined)
                                    item.hidden = variation.hidden

                                if (variation.sizes) {
                                    Object.keys(variation.sizes).forEach(variationSizeRef => {
                                        let variationSize = variation.sizes[variationSizeRef]
                                        let itemSize = item.sizes.filter(s => s.ref == variationSizeRef)[0]
                                        if (itemSize) {
                                            if (variationSize.label)
                                                itemSize.label = variationSize.label
                                            if (variationSize.price)
                                                itemSize.price = variationSize.price
                                        }
                                    })
                                }
                            }
                        })
                    });
                })

                // TODO Merge and obtain new object

                this.categories = context.categories
            })
        })
    },
    destroyed () {
        // console.log("destroyed")
    },
    beforeUpdate() {
        // console.log("beforeUpdate")

        // TODO Removed since currently is bugged (behavior stops working after section is changed)
        // document.querySelectorAll(".observable").forEach((element) => this.observer.unobserve(element));
    },
    updated() {
        // console.log("updated")
        document.querySelectorAll(".observable").forEach((element) => this.observer.observe(element));
    }
})

window.oncontextmenu = function(event) {
        event.preventDefault();
        event.stopPropagation();
        return false;
};

window.onbeforeunload = function() { return "Your work will be lost."; };

window.addEventListener('popstate', function (event) {
    document.getElementsByClassName("home").item(0).style.visibility='visible'
    document.getElementById("page").style.visibility='hidden'

    document.getElementsByClassName("popup").item(0).style.display='block'
});

function closeHome() {
    document.getElementsByClassName("home").item(0).style.visibility='hidden'
    document.getElementById("page").style.visibility='visible'
    history.pushState(null, document.title, location.href);

    document.getElementsByClassName("popup").item(0).style.display='none'
}

/* IMAGE POPUP */

function closeImagePopup() {
    let backdrop = document.getElementsByClassName("backdrop")[0]
    let popup = document.getElementsByClassName("popup")[0]
    backdrop.style.display = "none"
    popup.style.display = "none"
}

function onImageLoaded() {
    let loading = document.getElementsByClassName("popup-image-loading")[0]
    let exit = document.getElementsByClassName("popup-image-exit")[0]
    loading.style.visibility = "hidden"
    exit.style.visibility = "visible"
}

</script>