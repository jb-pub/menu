<html>
    <head>
        <link rel="stylesheet" href="index.css">
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    </head>
    <body>
        <div id="page">
            <div class="logo"></div>
            <div v-if="currentCategory">
                <div class="category-box box">
                    <!-- <div class="category-image"></div> -->
                    <div class="category-title">
                        <!-- <div style="display: grid; grid-template-rows: 1fr 1fr;"> -->
                        <div v-bind:class="{ 'subcategory-header': currentSubcategory }">
                            <div v-on:click="currentCategory.selected = false; currentCategory = null;">{{currentCategory.name}}</div>
                            <div style="display: grid; grid-template-columns: 3vw 1fr; align-content: center;" v-if="currentSubcategory">
                                <div style="margin-right: 1vw;" class="category-button small" v-bind:class="{'minus':currentSubcategory.expanded, 'plus':!currentSubcategory.expanded}"></div>
                                <div v-on:click="currentSubcategory.expanded = false">{{currentSubcategory.name}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="category-button minus" v-on:click="currentCategory.selected = false; currentCategory = null;"></div>
                    <!-- <div class="category-subtitle">SOTTOTITOLO</div> -->
                </div>
                <div class="items-container">
                    <div v-for="subcategory in currentCategory.subcategories" class="observable" v-bind:data-category-id="currentCategory.id" v-bind:data-subcategory-id="subcategory.id">
                        <div class="subcategory-box box">
                            <div class="subcategory-title observable" data-subcategory-header="true" v-bind:data-category-id="currentCategory.id" v-bind:data-subcategory-id="subcategory.id" v-on:click="subcategory.expanded = !subcategory.expanded">{{subcategory.name}}</div>
                            <div class="category-button" v-bind:class="{'minus':subcategory.expanded, 'plus':!subcategory.expanded}"></div>
                        </div>
                        <div class="item-box box" v-for="item in subcategory.items" v-if="subcategory.expanded">
                            <!-- <div class="item-column"> -->
                                <div class="item-title-bar">
                                    <div class="item-title">{{item.name}}</div>
                                    <img :content="infoTooltip(info)" v-tippy="{ trigger : 'mouseenter', size: 'large', arrow: 'true' }" class="info-icon" v-for="info in item.infos" v-bind:src="'images/allergens_' + info + '.png'">
                                </div>
                                <div class="prices-grid">
                                    <template v-for="size in item.sizes">
                                        <div class="item-description">{{size.label}}</div>
                                        <div class="item-description">{{size.price}}</div>
                                    </template>
                                </div>
                                <!-- <div class="item-description" style="margin-top: 1vh;">{{item.description}}</div>
                                <div class="item-description" style="display: flex; align-items: center; margin-top: 2vh;">
                                    <span style="margin-right: 1vh;">Contiene:</span>
                                    <img :content="infoTooltip(allergen)" v-tippy="{ trigger : 'mouseenter', size: 'large', arrow: 'true' }" class="info-icon" v-for="allergen in item.allergens" v-bind:src="'images/allergens_' + allergen + '.png'">
                                </div> -->
                                <div class="item-description">{{item.description}}</div>
                                <div class="allergens-row">
                                    <div class="item-description">Contiene:</div>
                                    <img :content="infoTooltip(allergen)" v-tippy="{ trigger : 'mouseenter', size: 'large', arrow: 'true' }" class="info-icon" v-for="allergen in item.allergens" v-bind:src="'images/allergens_' + allergen + '.png'">
                                </div>

                            <!-- </div> -->
                            <!-- <div class="prices-grid"> -->
                                <!-- <template v-for="size in item.sizes"> -->                         
                                <!-- </template> -->
                            <!-- </div>     -->
                        </div>
                    </div>
    
                </div>
            </div>
            <div class="categories-column" v-if="!currentCategory">
                <!-- <div v-for="category in categories" v-bind:category="category" v-bind:style="{ 'background-image': 'url(\'./images/JB.macro.headers_' + category.id + '_ita.jpg\')'}"> -->
                <div v-for="category in categories">
                    <div class="category-box box" v-on:click="category.selected = !category.selected; currentCategory = category.selected ? category : null;">
                        <!-- <div class="category-image"></div> -->
                        <div class="category-title"><span>{{category.name}}</span></div>
                        <div class="category-button plus"></div>
                        <!-- <div class="category-subtitle">SOTTOTITOLO</div> -->
                    </div>
                </div>
            </div>
            <div></div>
        </div>
    </body>

    
</html>

<script src="https://unpkg.com/vue-tippy/dist/vue-tippy.min.js"></script>

<script type="text/javascript">

var page = new Vue({
    el: '#page',
    data: {
        observer: null,
        currentCategory: null,
        categories: [],
        infos: {
            "celery": { "name": "Sedano" },
            "crustaceans": { "name": "Crostacei" },
            "eggs": { "name": "Uova" },
            "fish": { "name": "Pesce" },
            "gluten": { "name": "Glutine" },
            "herbs": { "name": "Speziato" },
            "lupin": { "name": "Lupino" },
            "milk": { "name": "Lattosio" },
            "molluscs": { "name": "Molluschi" },
            "mustard": { "name": "Senape" },
            "peanuts": { "name": "Arachidi" },
            "sesame": { "name": "Sesamo" },
            "soya": { "name": "Soya" },
            "spicyhot": { "name": "Piccante" },
            "sulphites": { "name": "Solfiti" },
            "tree_nuts": { "name": "Frutta a guscio" },
            "vegan": { "name": "Vegan" },
        }    
    },
    computed: {
        currentSubcategory() {
            let visibleSubcategories = []
            this.categories.forEach((category) => {
                category.subcategories.forEach((subcategory) => {
                    if (subcategory.visible) visibleSubcategories.push(subcategory)
                })
            })


            let anyHeaderVisible = false
            this.categories.forEach((category) => {
                category.subcategories.forEach((subcategory) => {
                    if (subcategory.headerVisible) anyHeaderVisible = true
                })
            })

            // console.log(visibleSubcategories)
            if (visibleSubcategories.length != 1 || anyHeaderVisible) return null
            else return visibleSubcategories[0]
        }
    },
    methods: {
        // showTooltip(event) {
        //     let element = event.target
        //     // let content = element.title
        //     tippy(element, {
        //         trigger: "manual",
        //         onShow: function(instance) {
        //             setTimeout(() => {
        //                 instance.destroy()
        //             }, 800);
        //         }
        //     }).show()
        // },
        infoTooltip(info) {
            return this.infos[info].name
        },
        onElementObserved(entries) {
            entries.forEach((entry) => {
                let subcategory = this.lookup(entry.target.dataset.categoryId, entry.target.dataset.subcategoryId)
                let subcategoryHeader = entry.target.dataset.subcategoryHeader ? true : false

                // console.log(entry)

                if (subcategoryHeader) {
                    subcategory.headerVisible = entry.isIntersecting
                }
                else {
                    subcategory.visible = entry.isIntersecting
                }

                // console.log("subcat " + subcategory.name + " vis " + subcategory.visible + " head " + subcategory.headerVisible)

                // console.log(subcategoryHeader)
                // console.log(this.currentSubcategory)
                // console.log(entry.isIntersecting)

                
            })
        },
        lookup(categoryId, subcategoryId) {
            let category = this.categories.filter((category) => category.id == categoryId)[0]
            let subcategory = null
            if (subcategoryId !== undefined ) {
                subcategory = category.subcategories.filter((subcategory) => subcategory.id == subcategoryId)[0]
                return subcategory
            }
            else return category
        }
    },
    created: function () {

        let options = {
            root: this.$el,
            rootMargin: '0px',
            // threshold: 1.0
            threshold: 0
        }
        this.observer = new IntersectionObserver(this.onElementObserved, options);

        fetch("./context.json")
            .then((resp) => resp.json())
            .then((json) => {

                json.categories.forEach(category => {
                    category.selected = false

                    category.subcategories.forEach(subcategory => {
                        subcategory.expanded = false
                        subcategory.visible = null
                        subcategory.headerVisible = null
                    });
                })

                this.categories = json.categories
            })
    },
    destroyed () {
        // console.log("destroyed")
    },
    beforeUpdate() {
        // console.log("beforeUpdate")
        document.querySelectorAll(".observable").forEach((element) => this.observer.unobserve(element));
    },
    updated() {
        // console.log("updated")
        document.querySelectorAll(".observable").forEach((element) => this.observer.observe(element));
    }
})

window.oncontextmenu = function(event) {
        event.preventDefault();
        event.stopPropagation();
        return false;
};

</script>